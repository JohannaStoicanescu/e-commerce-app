<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canary Deployment Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .header h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status.canary {
        background: #fff3cd;
        color: #856404;
      }

      .status.stable {
        background: #d4edda;
        color: #155724;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .metric-card h3 {
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .metric-value {
        font-size: 24px;
        font-weight: 600;
        color: #2196f3;
        margin-bottom: 5px;
      }

      .metric-label {
        color: #666;
        font-size: 14px;
      }

      .comparison {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
      }

      .comparison-item {
        text-align: center;
      }

      .comparison-value {
        font-size: 18px;
        font-weight: 600;
      }

      .canary-value {
        color: #ff9800;
      }

      .stable-value {
        color: #4caf50;
      }

      .actions {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .actions h3 {
        margin-bottom: 15px;
        color: #333;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        transition: all 0.2s;
      }

      .btn-promote {
        background: #4caf50;
        color: white;
      }

      .btn-rollback {
        background: #f44336;
        color: white;
      }

      .btn-adjust {
        background: #2196f3;
        color: white;
      }

      .btn-refresh {
        background: #9e9e9e;
        color: white;
      }

      .btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      .traffic-control {
        margin-top: 15px;
      }

      .traffic-slider {
        width: 100%;
        margin: 10px 0;
      }

      .traffic-value {
        font-weight: 600;
        color: #2196f3;
      }

      .logs {
        background: #1a1a1a;
        color: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-timestamp {
        color: #888;
      }

      .log-level {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin: 0 5px;
      }

      .log-info {
        background: #2196f3;
        color: white;
      }

      .log-error {
        background: #f44336;
        color: white;
      }

      .log-warning {
        background: #ff9800;
        color: white;
      }

      .error-indicator {
        color: #f44336;
      }

      .success-indicator {
        color: #4caf50;
      }

      @media (max-width: 768px) {
        .action-buttons {
          flex-direction: column;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üê§ Canary Deployment Dashboard</h1>
        <p>Monitor and manage your canary deployments</p>
        <div style="margin-top: 10px">
          <span class="status canary">Canary Active</span>
          <span class="status stable">Stable Running</span>
        </div>
      </div>

      <div class="actions">
        <h3>üéõÔ∏è Deployment Controls</h3>
        <div class="action-buttons">
          <a href="#" class="btn btn-promote" onclick="promoteCanary()"
            >üöÄ Promote to Stable</a
          >
          <a href="#" class="btn btn-rollback" onclick="rollbackCanary()"
            >‚è™ Rollback</a
          >
          <a href="#" class="btn btn-refresh" onclick="refreshMetrics()"
            >üîÑ Refresh</a
          >
        </div>

        <div class="traffic-control">
          <label for="trafficSlider"
            >Traffic to Canary:
            <span class="traffic-value" id="trafficValue">10%</span></label
          >
          <input
            type="range"
            id="trafficSlider"
            class="traffic-slider"
            min="0"
            max="100"
            value="10"
            onchange="updateTrafficValue()"
          />
          <button class="btn btn-adjust" onclick="adjustTraffic()">
            üìä Update Traffic
          </button>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <h3>üìä Session Metrics</h3>
          <div class="comparison">
            <div class="comparison-item">
              <div class="metric-value canary-value" id="canarySessions">-</div>
              <div class="metric-label">Canary Sessions</div>
            </div>
            <div class="comparison-item">
              <div class="metric-value stable-value" id="stableSessions">-</div>
              <div class="metric-label">Stable Sessions</div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <h3>üö® Error Tracking</h3>
          <div class="comparison">
            <div class="comparison-item">
              <div class="metric-value canary-value" id="canaryErrors">-</div>
              <div class="metric-label">Canary Errors</div>
            </div>
            <div class="comparison-item">
              <div class="metric-value stable-value" id="stableErrors">-</div>
              <div class="metric-label">Stable Errors</div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <h3>‚ö° Performance</h3>
          <div class="comparison">
            <div class="comparison-item">
              <div class="metric-value canary-value" id="canaryLoadTime">-</div>
              <div class="metric-label">Canary Load Time</div>
            </div>
            <div class="comparison-item">
              <div class="metric-value stable-value" id="stableLoadTime">-</div>
              <div class="metric-label">Stable Load Time</div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <h3>üëÜ User Interactions</h3>
          <div class="comparison">
            <div class="comparison-item">
              <div class="metric-value canary-value" id="canaryInteractions">
                -
              </div>
              <div class="metric-label">Canary Interactions</div>
            </div>
            <div class="comparison-item">
              <div class="metric-value stable-value" id="stableInteractions">
                -
              </div>
              <div class="metric-label">Stable Interactions</div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <h3>üìà Health Score</h3>
          <div style="text-align: center">
            <div class="metric-value" id="healthScore" style="color: #4caf50">
              100%
            </div>
            <div class="metric-label">Overall Health</div>
            <div style="margin-top: 10px">
              <span id="healthStatus" class="success-indicator"
                >‚úÖ Healthy</span
              >
            </div>
          </div>
        </div>

        <div class="metric-card">
          <h3>üéØ Error Rate Comparison</h3>
          <div style="text-align: center">
            <div class="metric-value" id="errorRateRatio">-</div>
            <div class="metric-label">Canary vs Stable Error Ratio</div>
            <div style="margin-top: 10px">
              <span id="errorRateStatus">-</span>
            </div>
          </div>
        </div>
      </div>

      <div class="logs">
        <h3 style="color: #f5f5f5; margin-bottom: 15px">üìã Deployment Logs</h3>
        <div id="logContainer">
          <div class="log-entry">
            <span class="log-timestamp">2024-01-15 10:30:00</span>
            <span class="log-level log-info">INFO</span>
            Dashboard initialized. Monitoring canary deployment...
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTrafficPercentage = 10;

      function updateTrafficValue() {
        const slider = document.getElementById("trafficSlider");
        const value = document.getElementById("trafficValue");
        value.textContent = slider.value + "%";
        currentTrafficPercentage = parseInt(slider.value);
      }

      function promoteCanary() {
        if (
          confirm(
            "Are you sure you want to promote the canary to stable? This will update the production environment."
          )
        ) {
          logMessage("Promoting canary to stable...", "info");

          // In a real implementation, this would call your GitHub Actions API
          fetch("/api/canary/promote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          })
            .then(() => {
              logMessage("‚úÖ Canary promoted to stable successfully!", "info");
              setTimeout(refreshMetrics, 2000);
            })
            .catch((error) => {
              logMessage(
                "‚ùå Failed to promote canary: " + error.message,
                "error"
              );
            });
        }
      }

      function rollbackCanary() {
        if (
          confirm(
            "Are you sure you want to rollback the canary deployment? This will revert to the last stable version."
          )
        ) {
          logMessage("Rolling back canary deployment...", "warning");

          fetch("/api/canary/rollback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          })
            .then(() => {
              logMessage("‚úÖ Canary rolled back successfully!", "info");
              setTimeout(refreshMetrics, 2000);
            })
            .catch((error) => {
              logMessage(
                "‚ùå Failed to rollback canary: " + error.message,
                "error"
              );
            });
        }
      }

      function adjustTraffic() {
        logMessage(
          `Adjusting canary traffic to ${currentTrafficPercentage}%...`,
          "info"
        );

        fetch("/api/canary/adjust-traffic", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ percentage: currentTrafficPercentage }),
        })
          .then(() => {
            logMessage(
              `‚úÖ Traffic adjusted to ${currentTrafficPercentage}%`,
              "info"
            );
            setTimeout(refreshMetrics, 2000);
          })
          .catch((error) => {
            logMessage(
              "‚ùå Failed to adjust traffic: " + error.message,
              "error"
            );
          });
      }

      function refreshMetrics() {
        logMessage("Refreshing metrics...", "info");

        // Try to get metrics from the canary monitor
        if (window.getCanaryAnalytics) {
          const analytics = window.getCanaryAnalytics();
          if (analytics) {
            updateDashboard(analytics);
            logMessage("‚úÖ Metrics updated from local storage", "info");
            return;
          }
        }

        // Fallback to mock data for demonstration
        const mockAnalytics = {
          canary: {
            sessions: Math.floor(Math.random() * 100) + 50,
            errors: Math.floor(Math.random() * 5),
            avgLoadTime: Math.floor(Math.random() * 1000) + 500,
            totalInteractions: Math.floor(Math.random() * 500) + 100,
          },
          stable: {
            sessions: Math.floor(Math.random() * 500) + 200,
            errors: Math.floor(Math.random() * 3),
            avgLoadTime: Math.floor(Math.random() * 800) + 400,
            totalInteractions: Math.floor(Math.random() * 1000) + 300,
          },
          comparison: {
            errorRateRatio: Math.random() * 2,
          },
        };

        updateDashboard(mockAnalytics);
        logMessage("‚úÖ Metrics updated with sample data", "info");
      }

      function updateDashboard(analytics) {
        // Update session metrics
        document.getElementById("canarySessions").textContent =
          analytics.canary.sessions;
        document.getElementById("stableSessions").textContent =
          analytics.stable.sessions;

        // Update error metrics
        document.getElementById("canaryErrors").textContent =
          analytics.canary.errors;
        document.getElementById("stableErrors").textContent =
          analytics.stable.errors;

        // Update performance metrics
        document.getElementById("canaryLoadTime").textContent =
          Math.round(analytics.canary.avgLoadTime) + "ms";
        document.getElementById("stableLoadTime").textContent =
          Math.round(analytics.stable.avgLoadTime) + "ms";

        // Update interaction metrics
        document.getElementById("canaryInteractions").textContent =
          analytics.canary.totalInteractions;
        document.getElementById("stableInteractions").textContent =
          analytics.stable.totalInteractions;

        // Calculate health score
        const canaryErrorRate =
          analytics.canary.sessions > 0
            ? analytics.canary.errors / analytics.canary.sessions
            : 0;
        const stableErrorRate =
          analytics.stable.sessions > 0
            ? analytics.stable.errors / analytics.stable.sessions
            : 0;
        const performanceRatio =
          analytics.canary.avgLoadTime / analytics.stable.avgLoadTime;

        let healthScore = 100;
        if (canaryErrorRate > stableErrorRate * 2) healthScore -= 40;
        if (performanceRatio > 1.5) healthScore -= 30;
        if (analytics.canary.sessions < 10) healthScore -= 20;

        healthScore = Math.max(0, Math.min(100, healthScore));

        document.getElementById("healthScore").textContent =
          Math.round(healthScore) + "%";
        const healthStatus = document.getElementById("healthStatus");

        if (healthScore >= 80) {
          healthStatus.textContent = "‚úÖ Healthy";
          healthStatus.className = "success-indicator";
        } else if (healthScore >= 60) {
          healthStatus.textContent = "‚ö†Ô∏è Warning";
          healthStatus.className = "log-warning";
        } else {
          healthStatus.textContent = "‚ùå Critical";
          healthStatus.className = "error-indicator";
        }

        // Update error rate comparison
        const ratio = analytics.comparison.errorRateRatio;
        document.getElementById("errorRateRatio").textContent = ratio
          ? ratio.toFixed(2) + "x"
          : "N/A";

        const errorRateStatus = document.getElementById("errorRateStatus");
        if (ratio > 2) {
          errorRateStatus.textContent = "‚ùå High Error Rate";
          errorRateStatus.className = "error-indicator";
        } else if (ratio > 1.2) {
          errorRateStatus.textContent = "‚ö†Ô∏è Elevated Errors";
          errorRateStatus.className = "log-warning";
        } else {
          errorRateStatus.textContent = "‚úÖ Normal";
          errorRateStatus.className = "success-indicator";
        }
      }

      function logMessage(message, level = "info") {
        const container = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = "log-entry";

        const timestamp = new Date().toLocaleString();
        const levelClass = `log-${level}`;
        const levelText = level.toUpperCase();

        entry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level ${levelClass}">${levelText}</span>
                ${message}
            `;

        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;

        // Keep only last 50 log entries
        while (container.children.length > 50) {
          container.removeChild(container.firstChild);
        }
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        logMessage("üöÄ Canary Dashboard initialized", "info");
        refreshMetrics();

        // Auto-refresh every 30 seconds
        setInterval(refreshMetrics, 30000);
      });
    </script>
  </body>
</html>
